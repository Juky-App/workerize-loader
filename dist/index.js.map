{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import path from 'path';\nimport loaderUtils from 'loader-utils';\n\nimport NodeTargetPlugin from 'webpack/lib/node/NodeTargetPlugin';\nimport SingleEntryPlugin from 'webpack/lib/SingleEntryPlugin';\nimport WebWorkerTemplatePlugin from 'webpack/lib/webworker/WebWorkerTemplatePlugin';\n\nexport default function loader() {}\n\nconst CACHE = {};\nconst tapName = 'workerize-loader';\n\nfunction compilationHook(compiler, handler) {\n\tif (compiler.hooks) {\n\t\treturn compiler.hooks.compilation.tap(tapName, handler);\n\t}\n\treturn compiler.plugin('compilation', handler);\n}\n\nfunction parseHook(data, handler) {\n\tif (data.normalModuleFactory.hooks) {\n\t\treturn data.normalModuleFactory.hooks.parser.for('javascript/auto').tap(tapName, handler);\n\t}\n\treturn data.normalModuleFactory.plugin('parser', handler);\n}\n\nfunction exportDeclarationHook(parser, handler) {\n\tif (parser.hooks) {\n\t\treturn parser.hooks.exportDeclaration.tap(tapName, handler);\n\t}\n\treturn parser.plugin('export declaration', handler);\n}\n\nloader.pitch = function(request) {\n\tthis.cacheable(false);\n\n\tconst options = loaderUtils.getOptions(this) || {};\n\n\tconst cb = this.async();\n\n\tconst filename = loaderUtils.interpolateName(this, `${options.name || '[hash]'}.worker.js`, {\n\t\tcontext: options.context || this.rootContext || this.options.context,\n\t\tregExp: options.regExp\n\t});\n\n\tconst worker = {};\n\n\tworker.options = {\n\t\tfilename,\n\t\tchunkFilename: `[id].${filename}`,\n\t\tnamedChunkFilename: null\n\t};\n\n\tconst compilerOptions = this._compiler.options || {};\n\tif (compilerOptions.output && compilerOptions.output.globalObject==='window') {\n\t\tconsole.warn('Warning (workerize-loader): output.globalObject is set to \"window\". It should be set to \"self\" or \"this\" to support HMR in Workers.');\n\t}\n\n\tconst isDevelopment = compilerOptions.mode === 'development';\n\n\tworker.compiler = this._compilation.createChildCompiler('worker', worker.options);\n\n\t(new WebWorkerTemplatePlugin(worker.options)).apply(worker.compiler);\n\n\tif (this.target!=='webworker' && this.target!=='web') {\n\t\t(new NodeTargetPlugin()).apply(worker.compiler);\n\t}\n\n\t(new SingleEntryPlugin(this.context, `!!${path.resolve(__dirname, 'rpc-worker-loader.js')}!${request}`, 'main')).apply(worker.compiler);\n\n\tconst subCache = `subcache ${__dirname} ${request}`;\n\n\tcompilationHook(worker.compiler, (compilation, data) => {\n\t\tif (compilation.cache) {\n\t\t\tif (!compilation.cache[subCache]) compilation.cache[subCache] = {};\n\n\t\t\tcompilation.cache = compilation.cache[subCache];\n\t\t}\n\t\tparseHook(data, (parser, options) => {\n\t\t\texportDeclarationHook(parser, expr => {\n\t\t\t\tlet decl = expr.declaration || expr,\n\t\t\t\t\t{ compilation, current } = parser.state,\n\t\t\t\t\tentry = compilation.entries[0].resource;\n\n\t\t\t\t// only process entry exports\n\t\t\t\tif (current.resource!==entry) return;\n\n\t\t\t\tlet exports = isDevelopment ?\n\t\t\t\t\tCACHE[entry] || (CACHE[entry] = {}) :\n\t\t\t\t\tcompilation.__workerizeExports || (compilation.__workerizeExports = {});\n\n\t\t\t\tif (decl.id) {\n\t\t\t\t\texports[decl.id.name] = true;\n\t\t\t\t}\n\t\t\t\telse if (decl.declarations) {\n\t\t\t\t\tfor (let i=0; i<decl.declarations.length; i++) {\n\t\t\t\t\t\texports[decl.declarations[i].id.name] = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tconsole.warn('[workerize] unknown export declaration: ', expr);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t});\n\n\tworker.compiler.runAsChild((err, entries, compilation) => {\n\t\tif (err) return cb(err);\n\n\t\tif (entries[0]) {\n\t\t\tworker.file = entries[0].files[0];\n\n\t\t\tlet entry = isDevelopment ? entries[0].entryModule.resource : undefined;\n\t\t\tlet contents = compilation.assets[worker.file].source();\n\t\t\tlet exports = isDevelopment ?\n\t\t\t\tObject.keys(CACHE[entry] || {}) :\n\t\t\t\tObject.keys(CACHE[worker.file] = compilation.__workerizeExports || CACHE[worker.file] || {});\n\n\t\t\t// console.log('Workerized exports: ', exports.join(', '));\n\n\t\t\tif (options.inline) {\n\t\t\t\tworker.url = `URL.createObjectURL(new Blob([${JSON.stringify(contents)}]))`;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tworker.url = `__webpack_public_path__ + ${JSON.stringify(worker.file)}`;\n\t\t\t}\n\n\t\t\tif (options.fallback === false) {\n\t\t\t\tdelete this._compilation.assets[worker.file];\n\t\t\t}\n\n\t\t\treturn cb(null, `\n\t\t\t\tvar addMethods = require(${loaderUtils.stringifyRequest(this, path.resolve(__dirname, 'rpc-wrapper.js'))})\n\t\t\t\tvar methods = ${JSON.stringify(exports)}\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(${worker.url}, { name: ${JSON.stringify(filename)} })\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t${ options.ready ? 'w.ready = new Promise(function(r) { w.addEventListener(\"ready\", function(){ r(w) }) })' : '' }\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t`);\n\t\t}\n\n\t\treturn cb(null, null);\n\t});\n};\n"],"names":["loader","const","CACHE","tapName","compilationHook","compiler","handler","hooks","compilation","tap","plugin","parseHook","data","normalModuleFactory","parser","for","exportDeclarationHook","exportDeclaration","pitch","request","cacheable","options","loaderUtils","getOptions","cb","async","filename","interpolateName","name","context","rootContext","regExp","worker","chunkFilename","namedChunkFilename","compilerOptions","_compiler","output","globalObject","console","warn","isDevelopment","mode","_compilation","createChildCompiler","WebWorkerTemplatePlugin","apply","target","NodeTargetPlugin","SingleEntryPlugin","path","resolve","__dirname","subCache","cache","expr","decl","declaration","state","current","entry","entries","resource","exports","__workerizeExports","id","declarations","let","i","length","runAsChild","err","file","files","entryModule","undefined","contents","assets","source","Object","keys","inline","url","JSON","stringify","fallback","this","stringifyRequest","ready"],"mappings":"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"}